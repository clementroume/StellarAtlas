# This Nginx configuration is designed to run *inside* a container,
# serving a Single Page Application (like Angular).
# It sits *behind* Traefik, which handles all public-facing traffic and SSL.

# Define the user and worker processes for Nginx
user  nginx;
# 'auto' automatically detects the number of CPU cores
worker_processes auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # Include standard MIME types to correctly serve CSS, JS, images, etc.
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # --- Performance Optimizations ---
    sendfile        on;
    tcp_nopush      on;
    keepalive_timeout  65;

    # --- Main Server Block ---
    # This server block defines how to serve the Angular application.
    server {
        # This container listens *only* on port 80 (HTTP) internally.
        # Traefik will route external HTTPS traffic (port 443) to this port.
        listen 80;

        # Internal server name, used for logging and internal reference.
        server_name stellar.apex;

        # Define the root directory where 'ng build' placed the static files.
        root   /usr/share/nginx/html;
        index  index.html;

        # --- Asset Compression ---
        # Enable on-the-fly gzip compression to reduce asset size.
        gzip on;
        gzip_proxied any;
        gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;

        # --- SPA Fallback ---
        # This is the most critical block for an Angular application.
        # It ensures that all deep links (e.g., /account/profile) are
        # routed to /index.html, allowing the Angular router to take over.
        location / {
            # 1. Try to find the exact file requested (e.g., /main.js)
            # 2. If not found, try it as a directory (e.g., /assets/)
            # 3. If still not found, serve /index.html as a fallback.
            try_files $uri $uri/ /index.html;
        }

        # NOTE: All 'location /api/' and 'location /swagger-ui' blocks
        # have been removed. Traefik now handles this routing
        # at the edge, before traffic ever reaches this container.
    }
}
